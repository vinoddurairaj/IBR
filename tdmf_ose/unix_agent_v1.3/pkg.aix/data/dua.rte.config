#!/bin/sh

# insert system startup hooks in /etc/rc
# usage is to prepare the driver prior
# to any filesystem activity, the driver
# should be up and running before the
# system accesses volumes under its control.

# also, insert an entry in /etc/services

# rc related files this script touches
PKGNAME=dua
#SVCNAME=tdmfAgent
rcdir=/etc
rcfil=rc
rcsv=rc.pre-$PKGNAME.$$
rcsedtmp=/tmp/rcsedtmp-$PKGNAME.$$

# services related files this script touches
svcdir=/etc
svcfil=services
svcsv=services.pre-$PKGNAME.$$

# default rmd port number 
duaport=577

# whether access is permitted
whoami=`id -u`
if [ "${whoami}" != "0" ]
then
	echo "$0: must be root";
	exit 1;
fi

unedit=0;
while getopts u o
do
        case ${o} in
                u)      unedit=1;;
                ?)      Usg; exit 2;;
        esac
done

# unedit?
#if [ ${unedit} -eq 1 ]
#then
#	# rc file 
#	cp ${rcdir}/${rcfil} ${rcdir}/${rcsv};
#	cat ${rcdir}/${rcsv} |\
#	sed -e '/@@@ TDMF Unix Agent START RC + @@@/,/@@@ TDMF Unix Agent START RC - @@@/d' \
#	> ${rcdir}/${rcfil};
#	echo "$0: TDMF Unix Agent service deinstalled";
#	# clean up
#	rm -f ${rcdir}/rc.pre-$PKGNAME.*
#  
#	## services file
#	#cp ${svcdir}/${svcfil} ${svcdir}/${svcsv};
#	#cat ${svcdir}/${svcsv} |\
#	#sed -e '/^$SVCNAME/d' > ${svcdir}/${svcfil};
#	## clean up
#	#rm -f ${svcdir}/services.pre-$PKGNAME.*
#
#	exit 0;
#fi

# chk whether already done

startinstalled=0;
cat ${rcdir}/${rcfil} |\
sed -n -e '/@@@ Replicator Agent START RC + @@@/,/@@@ Replicator Agent START RC - @@@/p' |\
egrep "(^/etc/$PKGNAME/init.d/SFTKdua)" 1> /dev/null 2>&1
if [ $? -eq 0 ]
then
	echo "$0: Replicator Agent service already installed";
	startinstalled=1;
else
	echo "$0: Replicator Agent service is not installed";
	echo "$0: installing Replicator Agent service";
fi

if [ ${startinstalled} -eq 0 ]
then

# chk for the context to be modified 
# insert the hook right after swap is configured.
lnum=`cat ${rcdir}/${rcfil} | sed -n -e '/^# @@@ DTC DRIVER START RC - @@@/='`
if [ xx"${lnum}" = "xx" ]
then
	echo "$0: context to modify not found";
	exit 1;
fi

# line preceding this address
lnum=`expr ${lnum} + 1`
echo "$0: inserting Replicator Agent service at line ${lnum} of ${rcdir}/${rcfil}"

# make a backup copy of /etc/rc
cp ${rcdir}/${rcfil} ${rcdir}/${rcsv}

# make a sed command
cat > ${rcsedtmp} << EOSEDCMD
${lnum} a\\
\\
# @@@ Replicator Agent START RC + @@@\\
# Start Replicator Agent service\\
/etc/dua/init.d/SFTKdua start\\
# @@@ Replicator Agent START RC - @@@\\

EOSEDCMD

# apply the patch
cat ${rcdir}/${rcsv} | sed -f ${rcsedtmp} > ${rcdir}/${rcfil}

# clean up
rm -f ${rcsedtmp} ${rcdir}/${rcsv}

# all might be well
echo "";
echo "$0: advice:";
echo "";
echo "    please inspect ${rcdir}/${rcfil}.";
echo "";
echo "    the following lines have been added";
echo "    between configuration of the system";
echo "    swap devices, and before filesystem";
echo "    checks:";
echo "";
echo "# @@@ Replicator Agent START RC + @@@";
echo "# Start Replicator Agent service";
echo "/etc/dua/init.d/SFTKdua start";
echo "# @@@ Replicator Agent START RC - @@@";
echo "";

fi # (if [ ${startinstalled} -eq 1 ])

# services file

# check already done
#cat ${svcdir}/${svcfil} | \
#egrep "(^$SVCNAME)" 1> /dev/null 2>&1
#if [ $? -eq 0 ]
#then
#	echo "$0: ${svcdir}/${svcfil} entry installed";
#	exit 0;
#else
#	echo "$0: ${svcdir}/${svcfil} entry not installed";
#	echo "$0: installing ${svcdir}/${svcfil} entry";
#fi

# install services file entry

# make a backup copy of services file
#cp ${svcdir}/${svcfil} ${svcdir}/${svcsv};

# install entry
#echo "$SVCNAME\t${duaport}/tcp" >> ${svcdir}/${svcfil};

# all might be well
#echo "";
#echo "$0: advice:";
#echo "";
#echo "    please inspect ${svcdir}/${svcfil}.";
#echo "";
#echo "    the following line has been added:";
#echo "";
#echo "    $SVCNAME\t\t${duaport}/tcp";
#echo "";

# all done
exit 0;
